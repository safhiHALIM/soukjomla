<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Filtrage par Cat√©gorie</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <h2 class="text-center mb-4">üè∑Ô∏è Test - Filtrage par Cat√©gorie</h2>
                
                <!-- Test du Dropdown Navbar -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-list"></i> Test du Dropdown Navbar</h5>
                    </div>
                    <div class="card-body">
                        <p>Simulation du dropdown de cat√©gories de la navbar :</p>
                        
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-tags"></i> Cat√©gories
                            </button>
                            <ul class="dropdown-menu" id="testCategoriesDropdown">
                                <li><a class="dropdown-item" href="#" onclick="testFilterByCategory('', 'Tous les produits')">
                                    <i class="bi bi-grid" style="font-size: 1.2rem; margin-right: 0.5rem; color: #1ee98a;"></i>
                                    Tous les produits
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <!-- Les cat√©gories seront charg√©es ici -->
                            </ul>
                        </div>
                        
                        <div id="filterResult" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Test API -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-cloud-arrow-up"></i> Test API de Filtrage</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="testGetAllProducts()">
                                    <i class="bi bi-list"></i> Tous les Produits
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="testFilterByFirstCategory()">
                                    <i class="bi bi-filter"></i> Filtrer par 1√®re Cat√©gorie
                                </button>
                            </div>
                            <div class="col-md-4 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="testFilterBySecondCategory()">
                                    <i class="bi bi-filter"></i> Filtrer par 2√®me Cat√©gorie
                                </button>
                            </div>
                        </div>
                        
                        <div id="apiTestResult" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Interface Utilisateur -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-eye"></i> Test Interface Utilisateur</h5>
                    </div>
                    <div class="card-body">
                        <p>Testez l'interface compl√®te :</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <a href="/" class="btn btn-success w-100 mb-2" target="_blank">
                                    <i class="bi bi-house"></i> Page d'Accueil
                                </a>
                                <small class="text-muted d-block">Cliquez sur une cat√©gorie dans la grille</small>
                            </div>
                            <div class="col-md-6">
                                <a href="/#catalog" class="btn btn-primary w-100 mb-2" target="_blank">
                                    <i class="bi bi-grid"></i> Page Catalogue
                                </a>
                                <small class="text-muted d-block">Utilisez le dropdown "Cat√©gories" dans la navbar</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- R√©sultats -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Logs et R√©sultats</h5>
                    </div>
                    <div class="card-body">
                        <div id="logs" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                            <div class="text-muted">Pr√™t pour les tests...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let categories = [];
        let products = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : 'text-info';
            
            logs.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Charger les cat√©gories au d√©marrage
        async function loadCategories() {
            try {
                log('üîÑ Chargement des cat√©gories...', 'info');
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if (data.success) {
                    categories = data.categories;
                    log(`‚úÖ ${categories.length} cat√©gories charg√©es`, 'success');
                    updateTestDropdown();
                    
                    // Afficher les cat√©gories
                    categories.forEach(cat => {
                        log(`üìÇ ${cat.name} (ID: ${cat.id}) - Ic√¥ne: ${cat.icon}`, 'info');
                    });
                } else {
                    log('‚ùå Erreur lors du chargement des cat√©gories', 'error');
                }
            } catch (error) {
                log('‚ùå Erreur r√©seau: ' + error.message, 'error');
            }
        }
        
        function updateTestDropdown() {
            const dropdown = document.getElementById('testCategoriesDropdown');
            const categoriesHtml = categories.map(category => 
                `<li><a class="dropdown-item" href="#" onclick="testFilterByCategory(${category.id}, '${category.name}')">
                    <i class="${category.icon}" style="font-size: 1.2rem; margin-right: 0.5rem; color: #1ee98a;"></i>
                    ${category.name}
                </a></li>`
            ).join('');
            
            // Ajouter les cat√©gories apr√®s le s√©parateur
            const allProductsItem = dropdown.querySelector('li:first-child');
            const divider = dropdown.querySelector('hr');
            dropdown.innerHTML = '';
            dropdown.appendChild(allProductsItem);
            dropdown.appendChild(divider.parentElement);
            dropdown.innerHTML += categoriesHtml;
        }
        
        async function testFilterByCategory(categoryId, categoryName) {
            log(`üè∑Ô∏è Test filtrage par cat√©gorie: ${categoryName} (ID: ${categoryId})`, 'info');
            
            try {
                const url = categoryId ? `/api/products?category_id=${categoryId}` : '/api/products';
                log(`üîó URL: ${url}`, 'info');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const count = data.products.length;
                    log(`‚úÖ ${count} produits trouv√©s pour "${categoryName}"`, 'success');
                    
                    // Afficher le r√©sultat
                    const result = document.getElementById('filterResult');
                    result.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="${categoryId ? categories.find(c => c.id == categoryId)?.icon || 'bi-tag' : 'bi-grid'}"></i> ${categoryName}</h6>
                            <p class="mb-0">${count} produits trouv√©s</p>
                        </div>
                    `;
                    
                    // Afficher quelques produits
                    if (count > 0) {
                        data.products.slice(0, 3).forEach(product => {
                            log(`üì¶ ${product.name} - ${product.price}‚Ç¨ (Cat√©gorie: ${product.category_name || 'N/A'})`, 'info');
                        });
                    }
                } else {
                    log('‚ùå Erreur API: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Erreur r√©seau: ' + error.message, 'error');
            }
        }
        
        async function testGetAllProducts() {
            log('üìã Test r√©cup√©ration de tous les produits', 'info');
            await testFilterByCategory('', 'Tous les produits');
        }
        
        async function testFilterByFirstCategory() {
            if (categories.length > 0) {
                const firstCategory = categories[0];
                log('ü•á Test avec la premi√®re cat√©gorie', 'info');
                await testFilterByCategory(firstCategory.id, firstCategory.name);
            } else {
                log('‚ö†Ô∏è Aucune cat√©gorie disponible', 'warning');
            }
        }
        
        async function testFilterBySecondCategory() {
            if (categories.length > 1) {
                const secondCategory = categories[1];
                log('ü•à Test avec la deuxi√®me cat√©gorie', 'info');
                await testFilterByCategory(secondCategory.id, secondCategory.name);
            } else {
                log('‚ö†Ô∏è Moins de 2 cat√©gories disponibles', 'warning');
            }
        }
        
        // Tests automatiques au chargement
        window.addEventListener('load', async function() {
            log('üöÄ Page de test charg√©e', 'success');
            await loadCategories();
            
            log('üìã Instructions:', 'info');
            log('1. Testez le dropdown ci-dessus', 'info');
            log('2. Testez les boutons API', 'info');
            log('3. Ouvrez la vraie interface dans un nouvel onglet', 'info');
        });
    </script>
</body>
</html>