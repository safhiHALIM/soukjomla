<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Gestion des Cat√©gories</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <h2 class="text-center mb-4">üè∑Ô∏è Test - Gestion des Cat√©gories</h2>
                
                <!-- √âtape 1: Migration -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-database-gear"></i> √âtape 1: Migration de la Base de Donn√©es</h5>
                    </div>
                    <div class="card-body">
                        <p>Ajout de la colonne <code>icon</code> √† la table <code>categories</code> et cr√©ation des cat√©gories √©lectroniques.</p>
                        
                        <button id="migrateBtn" class="btn btn-success" onclick="runMigration()">
                            <i class="bi bi-play-circle"></i> Ex√©cuter la Migration
                        </button>
                        
                        <div id="migrationResult" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- √âtape 2: Test API -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-cloud-arrow-up"></i> √âtape 2: Test des API</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="testGetCategories()">
                                    <i class="bi bi-list"></i> GET Categories
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="testCreateCategory()">
                                    <i class="bi bi-plus"></i> POST Category
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="testUpdateCategory()">
                                    <i class="bi bi-pencil"></i> PUT Category
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-danger w-100" onclick="testDeleteCategory()">
                                    <i class="bi bi-trash"></i> DELETE Category
                                </button>
                            </div>
                        </div>
                        
                        <div id="apiResult" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- √âtape 3: Interface Admin -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> √âtape 3: Interface Admin</h5>
                    </div>
                    <div class="card-body">
                        <p>Testez l'interface admin pour g√©rer les cat√©gories :</p>
                        
                        <a href="/admin" class="btn btn-success" target="_blank">
                            <i class="bi bi-box-arrow-up-right"></i> Ouvrir l'Admin Panel
                        </a>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Identifiants :</strong> admin / admin123<br>
                                <strong>Navigation :</strong> Cliquez sur "Categories" dans le menu de gauche
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- R√©sultats -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Logs et R√©sultats</h5>
                    </div>
                    <div class="card-body">
                        <div id="logs" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                            <div class="text-muted">Pr√™t pour les tests...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testCategoryId = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : 'text-info';
            
            logs.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        async function runMigration() {
            const btn = document.getElementById('migrateBtn');
            const result = document.getElementById('migrationResult');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Migration en cours...';
            log('üîÑ D√©marrage de la migration...', 'info');
            
            try {
                const response = await fetch('/api/migrate-categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
                    log('‚úÖ Migration r√©ussie !', 'success');
                    log(`üìä ${data.categories.length} cat√©gories cr√©√©es`, 'success');
                } else {
                    result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.message}</div>`;
                    log('‚ùå Erreur de migration: ' + data.message, 'error');
                }
                
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Erreur: ${error.message}</div>`;
                log('‚ùå Erreur r√©seau: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Migration Termin√©e';
        }
        
        async function testGetCategories() {
            log('üîç Test GET /api/categories', 'info');
            
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ GET r√©ussi: ${data.categories.length} cat√©gories trouv√©es`, 'success');
                    displayApiResult('GET Categories', data.categories);
                } else {
                    log('‚ùå GET √©chou√©: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Erreur GET: ' + error.message, 'error');
            }
        }
        
        async function testCreateCategory() {
            log('‚ûï Test POST /api/admin/categories', 'info');
            
            const categoryData = {
                name: 'Test Category ' + Date.now(),
                description: 'Cat√©gorie de test cr√©√©e automatiquement',
                icon: 'bi-star'
            };
            
            try {
                const response = await fetch('/api/admin/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    testCategoryId = data.category.id;
                    log(`‚úÖ POST r√©ussi: Cat√©gorie cr√©√©e avec ID ${testCategoryId}`, 'success');
                    displayApiResult('POST Category', data.category);
                } else {
                    log('‚ùå POST √©chou√©: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Erreur POST: ' + error.message, 'error');
            }
        }
        
        async function testUpdateCategory() {
            if (!testCategoryId) {
                log('‚ö†Ô∏è Cr√©ez d\'abord une cat√©gorie avec POST', 'warning');
                return;
            }
            
            log(`‚úèÔ∏è Test PUT /api/admin/categories/${testCategoryId}`, 'info');
            
            const updateData = {
                name: 'Test Category Updated',
                description: 'Cat√©gorie modifi√©e par le test',
                icon: 'bi-heart'
            };
            
            try {
                const response = await fetch(`/api/admin/categories/${testCategoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ PUT r√©ussi: Cat√©gorie modifi√©e', 'success');
                    displayApiResult('PUT Category', data.category);
                } else {
                    log('‚ùå PUT √©chou√©: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Erreur PUT: ' + error.message, 'error');
            }
        }
        
        async function testDeleteCategory() {
            if (!testCategoryId) {
                log('‚ö†Ô∏è Cr√©ez d\'abord une cat√©gorie avec POST', 'warning');
                return;
            }
            
            log(`üóëÔ∏è Test DELETE /api/admin/categories/${testCategoryId}`, 'info');
            
            try {
                const response = await fetch(`/api/admin/categories/${testCategoryId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ DELETE r√©ussi: Cat√©gorie supprim√©e', 'success');
                    testCategoryId = null;
                    displayApiResult('DELETE Category', { message: data.message });
                } else {
                    log('‚ùå DELETE √©chou√©: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Erreur DELETE: ' + error.message, 'error');
            }
        }
        
        function displayApiResult(title, data) {
            const result = document.getElementById('apiResult');
            result.innerHTML = `
                <div class="alert alert-info">
                    <h6>${title}</h6>
                    <pre class="mb-0" style="font-size: 0.8rem;">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        // Test automatique au chargement
        window.addEventListener('load', function() {
            log('üöÄ Page de test charg√©e', 'success');
            log('üìã √âtapes √† suivre:', 'info');
            log('1. Ex√©cuter la migration', 'info');
            log('2. Tester les API', 'info');
            log('3. Ouvrir l\'admin panel', 'info');
        });
    </script>
</body>
</html>