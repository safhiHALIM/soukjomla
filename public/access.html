<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Link - NeoSafi Store</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="min-vh-100 d-flex align-items-center justify-content-center">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <!-- Loading State -->
                    <div id="loadingState" class="card shadow">
                        <div class="card-body text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5>Verifying Access Link</h5>
                            <p class="text-muted">Please wait while we verify your access...</p>
                        </div>
                    </div>

                    <!-- Success State -->
                    <div id="successState" class="card shadow d-none">
                        <div class="card-body text-center py-5">
                            <div class="text-success mb-3">
                                <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                            </div>
                            <h4 class="text-success">Access Granted!</h4>
                            <p class="text-muted mb-4">Welcome to NeoSafi Store. You now have access to our exclusive content.</p>
                            <a href="/" class="btn btn-primary btn-lg">
                                <i class="bi bi-shop"></i> Enter Store
                            </a>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div id="errorState" class="card shadow d-none">
                        <div class="card-body text-center py-5">
                            <div class="text-danger mb-3">
                                <i class="bi bi-x-circle-fill" style="font-size: 3rem;"></i>
                            </div>
                            <h4 class="text-danger">Access Denied</h4>
                            <p class="text-muted mb-4" id="errorMessage">
                                This access link is invalid or has expired.
                            </p>
                            <a href="/" class="btn btn-outline-primary">
                                <i class="bi bi-house"></i> Go to Homepage
                            </a>
                        </div>
                    </div>

                    <!-- Device Already Used State -->
                    <div id="deviceUsedState" class="card shadow d-none">
                        <div class="card-body text-center py-5">
                            <div class="text-warning mb-3">
                                <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                            </div>
                            <h4 class="text-warning">Link Already Used</h4>
                            <p class="text-muted mb-4">
                                This access link has already been used on another device. 
                                Each link can only be used on one device for security reasons.
                            </p>
                            <div class="alert alert-info">
                                <small>
                                    <i class="bi bi-info-circle"></i>
                                    If you need access from this device, please contact the administrator 
                                    for a new access link.
                                </small>
                            </div>
                            <a href="/" class="btn btn-outline-primary">
                                <i class="bi bi-house"></i> Go to Homepage
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-3 mt-auto">
        <div class="container text-center">
            <small>&copy; 2024 NeoSafi Store. All rights reserved.</small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Device fingerprinting -->
    <script src="/js/device.js"></script>
    
    <script>
        // Extract token from URL
        const token = window.location.pathname.split('/access/')[1];
        
        if (!token) {
            showError('Invalid access link format');
        } else {
            checkAccessLink(token);
        }

        async function checkAccessLink(token) {
            try {
                // Generate device fingerprint
                const deviceId = generateDeviceId();
                
                // Send request to verify access
                const response = await fetch('/api/check-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        deviceId: deviceId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess();
                } else {
                    if (response.status === 403 && data.message.includes('another device')) {
                        showDeviceUsed();
                    } else {
                        showError(data.message || 'Access denied');
                    }
                }
            } catch (error) {
                console.error('Error checking access link:', error);
                showError('Network error. Please try again.');
            }
        }

        function showSuccess() {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('successState').classList.remove('d-none');
            
            // Store access granted flag
            sessionStorage.setItem('accessGranted', 'true');
            sessionStorage.setItem('accessToken', token);
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('d-none');
        }

        function showDeviceUsed() {
            document.getElementById('loadingState').classList.add('d-none');
            document.getElementById('deviceUsedState').classList.remove('d-none');
        }
    </script>
</body>
</html>